<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <title>Inikio</title>
    <link href="images/logo-icon.svg" rel="icon" type="image/svg">
    <script>var pathToRoot = "";</script>
    <script>const storage = localStorage.getItem("dokka-dark-mode")
    if (storage == null) {
        const osDarkSchemePreferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        if (osDarkSchemePreferred === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    } else {
        const savedDarkMode = JSON.parse(storage)
        if(savedDarkMode === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    }
    </script>
<script type="text/javascript" src="scripts/sourceset_dependencies.js" async="async"></script>
<link href="styles/style.css" rel="Stylesheet">
<link href="styles/jetbrains-mono.css" rel="Stylesheet">
<link href="styles/main.css" rel="Stylesheet">
<link href="styles/prism.css" rel="Stylesheet">
<link href="styles/logo-styles.css" rel="Stylesheet">
<script type="text/javascript" src="scripts/clipboard.js" async="async"></script>
<script type="text/javascript" src="scripts/navigation-loader.js" async="async"></script>
<script type="text/javascript" src="scripts/platform-content-handler.js" async="async"></script>
<script type="text/javascript" src="scripts/main.js" defer="defer"></script>
<script type="text/javascript" src="scripts/prism.js" async="async"></script>
<script type="text/javascript" src="scripts/symbol-parameters-wrapper_deferred.js" defer="defer"></script>
</head>
<body>
<div class="navigation-wrapper" id="navigation-wrapper">
    <div id="leftToggler"><span class="icon-toggler"></span></div>
    <div class="library-name">
            <a href="index.html">
                    <span>Inikio</span>
            </a>
    </div>
    <div>
    </div>
    <div class="pull-right d-flex">
        <button id="theme-toggle-button"><span id="theme-toggle"></span></button>
        <div id="searchBar"></div>
    </div>
</div>
<div id="container">
    <div id="leftColumn">
        <div id="sideMenu"></div>
    </div>
    <div id="main">
<div class="main-content" id="content" pageIds="Inikio::////PointingToDeclaration//-167733409">
  <div class="breadcrumbs"></div>
  <div class="cover ">
    <h1 class="cover"><span><span>Inikio</span></span></h1>
    <div class="platform-hinted UnderCoverText" data-platform-hinted="data-platform-hinted"><div class="content sourceset-dependent-content" data-active="" data-togglable=":inikio-core:dokkaHtml/commonMain"><blockquote class="quotation"><p class="paragraph">Better initial-style DSLs in Kotlin <a href="https://github.com/serras/inikio"> <img src="https://badgen.net/github/stars/serras/inikio?style=social&label=GitHub stars" /> </a></p></blockquote><br /><ul><li><p class="paragraph"><a href="#initial-style-dsls">Initial-style DSLs</a></p></li><ul><li><p class="paragraph"><a href="#execution">Execution</a></p></li><li><p class="paragraph"><a href="-inikio/fp.serrano.inikio.util/index.html">Utilities</a></p></li></ul><li><p class="paragraph"><a href="#suspended-syntax"><code>suspend</code>ed syntax</a></p></li><ul><li><p class="paragraph"><a href="-inikio/fp.serrano.inikio.plugin/index.html">Compiler plug-in</a></p></li></ul><li><p class="paragraph"><a href="https://github.com/serras/inikio/tree/main/inikio-examples/src/commonMain/kotlin/fp/serrano/inikio/examples">Examples of DSLs</a> </p></li></ul><p class="paragraph"><h3 id="initial-style-dsls">Initial-style DSLs</h3></p><p class="paragraph">Sometimes you need to model actions or behaviors as part of your model. For example, <a href="https://engineering.fb.com/2015/06/26/security/fighting-spam-with-haskell/">rules for filtering data</a>, <a href="https://github.com/epfl-lara/smart/blob/master/core/src/sphinx/smartcontracts.rst">smart contracts</a>, or <a href="https://serranofp.com/zurihac-workshop/">trading card games</a>. In most cases these actions come from a particular language, called a <i>domain-specific language</i> (DSL for short). Some people separate those actions from the programming language were they are used by means tools like <a href="https://www.jetbrains.com/mps/">JetBrains MPS</a>, but here we're concerned with actually representing those actions in our favorite programming language, Kotlin.</p><p class="paragraph">There are different patterns to embed DSLs in an existing language. <i>Initial-style</i> is one of them, referring to the case in which the actions are represented as <i>data</i>. Here's an example showing the basic elements of this pattern:</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">sealed interface Casino&lt;out A&gt;<br><br>data class Done&lt;out A&gt;(val result: A): Casino&lt;A&gt;<br>data class FlipCoin&lt;out A&gt;(val next: (Outcome) -&gt; Casino&lt;A&gt;): Casino&lt;A&gt; {<br>  enum class Outcome { HEADS, TAILS }<br>}</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><ol><li><p class="paragraph">An interface <code class="lang-kotlin">Casino</code> which forms the top of the sealed hierarchy.</p></li><li><p class="paragraph">A few <i>primitive actions</i>; in this case only one, <code class="lang-kotlin">FlipCoin</code>. Those actions from the basis of what you can express using your language.</p></li><li><p class="paragraph">A data class which &quot;ends&quot; the actions; in this case <code class="lang-kotlin">Done</code>.</p></li></ol><p class="paragraph">Each of the primitive actions in (2) also follow a particular shape. Their last argument is a <i>continuation</i>, a function which specifies the &quot;next&quot; action to be executed after this one. That function has as argument the type of data which is &quot;consumed&quot; by the action, and always refers back to the top of the sealed hierarchy as result.</p><p class="paragraph">Using <code class="lang-kotlin">Casino</code> we can express different games which depend on flipping coins. For example, here's a game in which you flip two coins, and you win whenever both are heads. Kotlin's ability to drop parentheses for a block argument gives us nice syntax to express what to do next after each <code class="lang-kotlin">FlipCoin</code>.</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">val doubleCoin =<br>  FlipCoin { o1 -&gt;<br>    FlipCoin { o2 -&gt;<br>      if (o1 == Outcome.HEADS &amp;&amp; o2 == Outcome.HEADS) <br>        Done(WIN)<br>      else<br>        Done(LOSE)<br>    }<br>  }</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph"><h4 id="execution">Execution</h4></p><p class="paragraph">Values of that initial-style DSL can be <i>executed</i> in different ways (sometimes we also say they are <i>interpreted</i>). In fact, the main advantage of describing actions using this pattern is that writing those interpretations is much simpler than in others. In most cases, you have a big <code class="lang-kotlin">when</code> to handle each of the primitive instructions, which calls itself (tail recursively) with the continuation.</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">tailrec fun &lt;A&gt; Casino&lt;A&gt;.execute(): A =<br>  when(this) {<br>    is Done -&gt; result<br>    is FlipCoin -&gt; next(Random.nextFlipOutcome()).execute()<br>  }<br><br>fun Random.nextFlipOutcome(): FlipCoin.Outcome =<br>  if (nextBoolean()) FlipCoin.Outcome.HEADS else FlipCoin.Outcome.TAILS</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph"><h3 id="suspended-syntax"><code>suspend</code>ed syntax</h3></p><p class="paragraph">As useful as it is for writing interpretations, initial-style DSLs suffer from a not-so-nice interface for creating values. The <code class="lang-kotlin">doubleCoin</code> above is a prime example: you need to nest everytime you use a primitive action, and remember to wrap the final result with <code class="lang-kotlin">Done</code>. Conceptually, though, that problem is a <i>sequence</i> of operations, and we would like that to be reflected in the way we write our code.</p><p class="paragraph">Fortunately, <a href="https://kotlinlang.org/docs/coroutines-overview.html">Kotlin's coroutine system</a> gives us enough tools to fulfill our wishes. Inikio just wraps them in a nice package, and provides a small compiler plug-in for the boilerplate we need to write. The main idea is to have a <code class="lang-kotlin">Builder</code> in which each primitive operation is represented as a <code class="lang-kotlin">suspend</code>ed method, and a runner which turns the <code class="lang-kotlin">Builder</code> into the actual initial-style DSL. </p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">// the builder class<br>class CasinoBuilder&lt;A&gt;: ProgramBuilder&lt;Casino&lt;A&gt;, A&gt; {<br>  suspend fun flipCoin(): FlipCoin.Outcome<br>}<br>// the runner<br>fun &lt;A&gt; casino(block: CasinoBuilder&lt;A&gt;.() -&gt; A): Casino&lt;A&gt;</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph">The <code class="lang-kotlin">doubleCoin</code> example can be re-written as follows.</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">val doubleCoin = casino {<br>  val o1 = flipCoin()<br>  val o2 = flipCoin()<br>  if (o1 == Outcome.HEADS &amp;&amp; o2 == Outcome.HEADS) WIN<br>  else LOSE<br>}</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph">At the core of this technique we have the <code class="lang-kotlin">ProgramBuilder</code> class, which implements a state machine on top of coroutines (thanks to <a href="https://twitter.com/vergauwen_simon/">Simon Vergauwen</a> and <a href="https://twitter.com/raulraja/">Raúl Raja</a> for teaching it to me!). The details are not important, but the general idea is that by turning each primitive operation into a <code class="lang-kotlin">suspend</code>ed function, the runner can &quot;detect&quot; when it's called, and produce the corresponding data class instance from the initial-style DSL.</p><p class="paragraph">The great news is that you can get all the benefits of this nicer style without having to write anything else than the initial-style DSL. The <a href="-inikio/fp.serrano.inikio.plugin/index.html">compiler plug-in</a> generates the <code class="lang-kotlin">Builder</code> and the runner for you.</p></div></div>
  </div>
  <h2 class="">Packages</h2>
  <div class="table"><a data-name="1188454737%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio" id="1188454737%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
    <div class="table-row" data-filterable-current=":inikio-core:dokkaHtml/commonMain" data-filterable-set=":inikio-core:dokkaHtml/commonMain">
      <div>
        <div class="main-subrow ">
          <div class=""><span class="inline-flex">
              <div><a href="-inikio/fp.serrano.inikio/index.html">fp.serrano.inikio</a></div>
<span class="anchor-wrapper"><span class="anchor-icon" pointing-to="1188454737%2FPackages%2F-167733409"></span>
                <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
              </span></span></div>
          <div class="pull-right"></div>
        </div>
        <div><span class="brief-comment"><a data-name="1188454737%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio" id="1188454737%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
            <p class="paragraph">The core <code class="lang-kotlin">ProgramBuilder</code> and corresponding runner. Every DSL generated by the plug-in is based on these two.</p>
          </span></div>
      </div>
    </div>
<a data-name="965808948%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio.plugin" id="965808948%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
    <div class="table-row" data-filterable-current=":inikio-core:dokkaHtml/commonMain" data-filterable-set=":inikio-core:dokkaHtml/commonMain">
      <div>
        <div class="main-subrow ">
          <div class=""><span class="inline-flex">
              <div><a href="-inikio/fp.serrano.inikio.plugin/index.html">fp.serrano.inikio.plugin</a></div>
<span class="anchor-wrapper"><span class="anchor-icon" pointing-to="965808948%2FPackages%2F-167733409"></span>
                <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
              </span></span></div>
          <div class="pull-right"></div>
        </div>
        <div><span class="brief-comment"><a data-name="965808948%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio.plugin" id="965808948%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
            <p class="paragraph">Information about Inikio's compiler plug-in, that creates <code class="lang-kotlin">Builder</code>s automatically for your initial-style DSLs.</p>
          </span></div>
      </div>
    </div>
<a data-name="-1988965629%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio.util" id="-1988965629%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
    <div class="table-row" data-filterable-current=":inikio-core:dokkaHtml/commonMain" data-filterable-set=":inikio-core:dokkaHtml/commonMain">
      <div>
        <div class="main-subrow ">
          <div class=""><span class="inline-flex">
              <div><a href="-inikio/fp.serrano.inikio.util/index.html">fp.serrano.inikio.util</a></div>
<span class="anchor-wrapper"><span class="anchor-icon" pointing-to="-1988965629%2FPackages%2F-167733409"></span>
                <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
              </span></span></div>
          <div class="pull-right"></div>
        </div>
        <div><span class="brief-comment"><a data-name="-1988965629%2FPackages%2F-167733409" anchor-label="fp.serrano.inikio.util" id="-1988965629%2FPackages%2F-167733409" data-filterable-set=":inikio-core:dokkaHtml/commonMain"></a>
            <p class="paragraph">Common patterns for building values of initial-style DSLs when using <code class="lang-kotlin">ProgramBuilder</code>.</p>
          </span></div>
      </div>
    </div>
  </div>
</div>
      <div class="footer">
        <span class="go-to-top-icon"><a href="#content" id="go-to-top-link"></a></span><span>© 2022 Copyright</span><span
                class="pull-right"><span>Generated by </span><a
                href="https://github.com/Kotlin/dokka"><span>dokka</span><span class="padded-icon"></span></a></span>
      </div>
    </div>
</div>
</body>
</html>
